namespace Cleo.Core.Domain.ValueObjects;

/// <summary>
/// The originator of an activity within a session.
/// </summary>
public enum ActivityOriginator
{
    User,
    Agent,
    System
}

/// <summary>
/// A tangible unit of data produced during a session activity.
/// </summary>
public abstract record Artifact;

/// <summary>
/// Evidence of a terminal command execution.
/// </summary>
public record CommandEvidence(string Command, string Output, int ExitCode) : Artifact;

/// <summary>
/// A formal code proposal (Patch).
/// </summary>
public record CodeProposal(SolutionPatch Patch) : Artifact;

/// <summary>
/// Media-based evidence (e.g., screenshots).
/// </summary>
public record MediaEvidence(string MimeType, string Data) : Artifact;

/// <summary>
/// Represents a single observable event in the Session Log.
/// Acts as a container for hierarchical Artifacts (Evidence).
/// </summary>
public abstract record SessionActivity(
    string Id, 
    DateTimeOffset Timestamp, 
    ActivityOriginator Originator,
    IReadOnlyCollection<Artifact> Evidence)
{
    /// <summary>
    /// Returns a human-friendly summary of the activity's primary content.
    /// </summary>
    public abstract string GetContentSummary();

    /// <summary>
    /// Returns technical or metadata details about the activity.
    /// </summary>
    public virtual string GetMetaDetail() => $"Originator: {Originator} | Evidence: {Evidence.Count}";
}

/// <summary>
/// A spoken exchange between the user and the agent (Dialogue/Feedback).
/// </summary>
public record MessageActivity(
    string Id, 
    DateTimeOffset Timestamp, 
    ActivityOriginator Originator, 
    string Text,
    IReadOnlyCollection<Artifact>? Evidence = null) 
    : SessionActivity(Id, Timestamp, Originator, Evidence ?? Array.Empty<Artifact>())
{
    public override string GetContentSummary() => Text;
}

/// <summary>
/// A structural roadmap generated by the agent.
/// </summary>
public record PlanningActivity(
    string Id, 
    DateTimeOffset Timestamp, 
    string PlanId, 
    IReadOnlyCollection<PlanStep> Steps,
    IReadOnlyCollection<Artifact>? Evidence = null) 
    : SessionActivity(Id, Timestamp, ActivityOriginator.Agent, Evidence ?? Array.Empty<Artifact>())
{
    public override string GetContentSummary() => $"Plan Generated: {PlanId} ({Steps.Count} steps)";
    public override string GetMetaDetail() => $"{base.GetMetaDetail()} | Steps: {Steps.Count}";
}

public record PlanStep(int Index, string Title, string Description);

/// <summary>
/// A formal approval of a proposed plan.
/// </summary>
public record ApprovalActivity(
    string Id, 
    DateTimeOffset Timestamp, 
    string PlanId,
    IReadOnlyCollection<Artifact>? Evidence = null)
    : SessionActivity(Id, Timestamp, ActivityOriginator.User, Evidence ?? Array.Empty<Artifact>())
{
    public override string GetContentSummary() => $"Plan Approved: {PlanId}";
}

/// <summary>
/// A moment-in-time heartbeat showing current status and progress.
/// </summary>
public record ProgressActivity(
    string Id, 
    DateTimeOffset Timestamp, 
    string Detail,
    IReadOnlyCollection<Artifact>? Evidence = null) 
    : SessionActivity(Id, Timestamp, ActivityOriginator.Agent, Evidence ?? Array.Empty<Artifact>())
{
    public override string GetContentSummary() => Detail;
}

/// <summary>
/// An activity representing the successful completion of the session.
/// </summary>
public record CompletionActivity(
    string Id, 
    DateTimeOffset Timestamp,
    IReadOnlyCollection<Artifact>? Evidence = null) 
    : SessionActivity(Id, Timestamp, ActivityOriginator.System, Evidence ?? Array.Empty<Artifact>())
{
    public override string GetContentSummary() => "Session Completed Successfully";
}

/// <summary>
/// An activity representing a terminal failure of the session.
/// </summary>
public record FailureActivity(
    string Id, 
    DateTimeOffset Timestamp, 
    string Reason,
    IReadOnlyCollection<Artifact>? Evidence = null) 
    : SessionActivity(Id, Timestamp, ActivityOriginator.System, Evidence ?? Array.Empty<Artifact>())
{
    public override string GetContentSummary() => $"FAILURE: {Reason}";
}
