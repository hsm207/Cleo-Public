namespace Cleo.Core.Domain.ValueObjects;

/// <summary>
/// The originator of an activity within a session.
/// </summary>
public enum ActivityOriginator
{
    User,
    Agent,
    System
}

/// <summary>
/// A tangible unit of data produced during a session activity.
/// </summary>
public abstract record Artifact
{
    public virtual string GetSummary() => "ðŸ“¦ Artifact produced.";
}

/// <summary>
/// Represents a single observable event in the Session Log.
/// Acts as a container for hierarchical Artifacts (Evidence).
/// </summary>
public abstract record SessionActivity(
    string Id, 
    DateTimeOffset Timestamp, 
    ActivityOriginator Originator,
    IReadOnlyCollection<Artifact> Evidence)
{
    /// <summary>
    /// Returns a human-friendly summary of the activity's primary content.
    /// </summary>
    public abstract string GetContentSummary();

    /// <summary>
    /// Returns technical or metadata details about the activity.
    /// </summary>
    public virtual string GetMetaDetail() => $"Originator: {Originator} | Evidence: {Evidence.Count}";

    /// <summary>
    /// Indicates whether this activity represents a major state transition or communication event.
    /// </summary>
    public virtual bool IsSignificant => true;
}

/// <summary>
/// A spoken exchange between the user and the agent (Dialogue/Feedback).
/// </summary>
public record MessageActivity(
    string Id, 
    DateTimeOffset Timestamp, 
    ActivityOriginator Originator, 
    string Text,
    IReadOnlyCollection<Artifact>? Evidence = null) 
    : SessionActivity(Id, Timestamp, Originator, Evidence ?? Array.Empty<Artifact>())
{
    public override string GetContentSummary() => Text;
}

/// <summary>
/// A structural roadmap generated by the agent.
/// </summary>
public record PlanningActivity(
    string Id, 
    DateTimeOffset Timestamp, 
    string PlanId, 
    IReadOnlyCollection<PlanStep> Steps,
    IReadOnlyCollection<Artifact>? Evidence = null) 
    : SessionActivity(Id, Timestamp, ActivityOriginator.Agent, Evidence ?? Array.Empty<Artifact>())
{
    public override string GetContentSummary() => $"Plan Generated: {PlanId} ({Steps.Count} steps)";
    public override string GetMetaDetail() => $"{base.GetMetaDetail()} | Steps: {Steps.Count}";
}

public record PlanStep(int Index, string Title, string Description);

/// <summary>
/// A formal approval of a proposed plan.
/// </summary>
public record ApprovalActivity(
    string Id, 
    DateTimeOffset Timestamp, 
    string PlanId,
    IReadOnlyCollection<Artifact>? Evidence = null)
    : SessionActivity(Id, Timestamp, ActivityOriginator.User, Evidence ?? Array.Empty<Artifact>())
{
    public override string GetContentSummary() => $"Plan Approved: {PlanId}";
}

/// <summary>
/// A moment-in-time heartbeat showing current status and progress.
/// </summary>
public record ProgressActivity(
    string Id, 
    DateTimeOffset Timestamp, 
    string Title,
    string? Description = null,
    IReadOnlyCollection<Artifact>? Evidence = null) 
    : SessionActivity(Id, Timestamp, ActivityOriginator.Agent, Evidence ?? Array.Empty<Artifact>())
{
    private const string Indent = "          "; // Indent to match "- [HH:mm] "

    public override string GetContentSummary()
    {
        var sb = new System.Text.StringBuilder();
        sb.Append(Title);

        if (!string.IsNullOrWhiteSpace(Description))
        {
            sb.AppendLine();
            sb.Append(Indent);
            sb.Append("ðŸ’­ ");
            sb.Append(Description.Replace("\n", $"\n{Indent}   ", StringComparison.Ordinal));
        }

        if (Evidence.Count > 0)
        {
            sb.AppendLine();
            sb.Append(Indent);
            sb.Append("ðŸ“¦ ");
            sb.Append(string.Join($"\n{Indent}ðŸ“¦ ", Evidence.Select(e => e.GetSummary())));
        }

        return sb.ToString();
    }

    public override bool IsSignificant => false;
}

/// <summary>
/// An activity representing the successful completion of the session.
/// </summary>
public record CompletionActivity(
    string Id, 
    DateTimeOffset Timestamp,
    IReadOnlyCollection<Artifact>? Evidence = null) 
    : SessionActivity(Id, Timestamp, ActivityOriginator.System, Evidence ?? Array.Empty<Artifact>())
{
    public override string GetContentSummary()
    {
        var baseMsg = "Session Completed Successfully";
        if (Evidence.Count > 0)
        {
            return $"{baseMsg} | {string.Join(" | ", Evidence.Select(e => e.GetSummary()))}";
        }
        return baseMsg;
    }
}

/// <summary>
/// An activity representing a terminal failure of the session.
/// </summary>
public record FailureActivity(
    string Id, 
    DateTimeOffset Timestamp, 
    string Reason,
    IReadOnlyCollection<Artifact>? Evidence = null) 
    : SessionActivity(Id, Timestamp, ActivityOriginator.System, Evidence ?? Array.Empty<Artifact>())
{
    public override string GetContentSummary() => $"FAILURE: {Reason}";
}
